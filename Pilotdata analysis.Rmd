---
title: "Pilotdata analysis"
author: "Lina Elkjær Pedersen"
date: "12/4/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r LIBRARIES}

library(tidyverse)
library(R2jags)
library(coda)
library(boot)
library(brms)
library(ggplot2)
library(cmdstanr)

packageVersion("rstan")

```




```{r}

#Loading data
data <- read_csv("dataweek1.csv")

#Getting rid of weird column...
data <-  data %>% 
  mutate(
    ...1 = NULL
  )

data_response <- subset(data, RT!="0")
```



```{r RT_from_onset as outcome}
get_prior(data = data_response, family = gaussian(), RT_from_onset ~ 1 + gender + (1| gender:ID))

m4_gaus_prior <-
  brm(data = data_response,
      family = gaussian(),
      RT_from_onset ~ 1 + gender + (1| gender:ID),
      prior =  c(prior(student_t(3, 5099, 1181), class = Intercept),
               prior(normal(4000, 1000), class = b),
               prior(student_t(3, 0, 1181), class = sd),
               prior(student_t(3, 0, 1181), class= sigma)),
      cores=2,
      chains=4,
      sample_prior = "only")

pp_check(m4_gaus_prior, ndraws = 100)+
  #xlim(-500,500)+
  ggtitle("M4 Prior Predictive Check")

#################

m4_gaus <-
  brm(data = data_response,
      family = gaussian,
      RT_from_onset ~ 1 + gender + (1| gender:ID),
      prior=c(prior(student_t(3, 5099, 1181), class = Intercept),
                prior(normal(4000, 1000), class = b),
                prior(student_t(3, 0, 1181), class = sd),
                prior(student_t(3, 0, 1181), class= sigma)),
      cores = 2,
      chains = 4,
      iter=5000,
      sample_prior = TRUE
      #control = list(adapt_delta = 0.999, max_treedepth = 15)
      )


pp_check(m4_gaus, ndraws = 100)+
  ggtitle("M4 Posterior Predictive Check")
summary(m4_gaus)


pairs(m4_gaus)
```



```{r RT as outcome}
get_prior(data = data_response, family = gaussian(), RT ~ 1 + gender + (1| gender:ID))

m4_gaus_RT_prior <-
  brm(data = data_response,
      family = gaussian(),
      RT~ 1 + gender + (1| gender:ID),
      prior =  c(prior(student_t(3, 5787, 2709), class = Intercept),
               prior(normal(4000, 1000), class = b),
               prior(student_t(3, 0, 2709), class = sd),
               prior(student_t(3, 0, 2709), class= sigma)),
      cores=2,
      chains=4,
      sample_prior = "only")

pp_check(m4_gaus_RT_prior, ndraws = 100)+
  #xlim(-500,500)+
  ggtitle("M4 Prior Predictive Check")

#################

m4_gaus_RT <-
  brm(data = data_response,
      family = gaussian,
      RT ~ 1 + gender + (1| gender:ID),
      prior=c(prior(student_t(3, 5787, 2709), class = Intercept),
                prior(normal(4000, 1000), class = b),
                prior(student_t(3, 0, 2709), class = sd),
                prior(student_t(3, 0, 2709), class= sigma)),
      cores = 2,
      chains = 4,
      iter=5000,
      sample_prior = TRUE
      #control = list(adapt_delta = 0.999, max_treedepth = 15)
      )


pp_check(m4_gaus_RT, ndraws = 100)+
  ggtitle("M4 Posterior Predictive Check")
summary(m4_gaus_RT)

```






```{r RT as outcome + stim}

get_prior(data = data_response, family = gaussian(), RT ~ 0 + gender:stim_category + (1| ID))

m4_gaus_RT_stim_prior <-
  brm(data = data_response,
      family = gaussian(),
      RT~ 0 + gender:stim_category + (1|ID),
      prior =  c(prior(normal(4000, 1000), class = b),
               prior(student_t(3, 0, 2709), class = sd),
               prior(student_t(3, 0, 2709), class= sigma)),
      cores=2,
      chains=4,
      sample_prior = "only")

pp_check(m4_gaus_RT_prior, ndraws = 100)+
  #xlim(-500,500)+
  ggtitle("M4 Prior Predictive Check")

#################

m4_gaus_RT_stim <-
  brm(data = data_response,
      family = gaussian,
      RT ~ 0 + gender:stim_category + (1|ID),
      prior=c(prior(normal(4000, 1000), class = b),
                prior(student_t(3, 0, 2709), class = sd),
                prior(student_t(3, 0, 2709), class= sigma)),
      cores = 2,
      chains = 4,
      iter=5000,
      sample_prior = TRUE
      #control = list(adapt_delta = 0.999, max_treedepth = 15)
      )


pp_check(m4_gaus_RT_stim, ndraws = 100)+
  ggtitle("M4 Posterior Predictive Check")
summary(m4_gaus_RT_stim)

################################################################################################

get_prior(data = data_response, family = gaussian(), RT ~ 1 + gender:stim_category + (1| ID))

m5_gaus_RT_stim_prior <-
  brm(data = data_response,
      family = gaussian(),
      RT~ 1 + gender:stim_category + (1|ID),
      prior =  c(prior(student_t(3, 5787, 2709), class = Intercept),
               prior(normal(4000, 1000), class = b),
               prior(student_t(3, 0, 2709), class = sd),
               prior(student_t(3, 0, 2709), class= sigma)),
      cores=2,
      chains=4,
      sample_prior = "only")

pp_check(m5_gaus_RT_stim_prior, ndraws = 100)+
  #xlim(-500,500)+
  ggtitle("M4 Prior Predictive Check")

#################

m5_gaus_RT_stim <-
  brm(data = data_response,
      family = gaussian,
      RT ~ 1 + gender + stim_category + (1|ID),
      prior=c(prior(student_t(3, 5787, 2709), class = Intercept),
                prior(normal(4000, 1000), class = b),
                prior(student_t(3, 0, 2709), class = sd),
                prior(student_t(3, 0, 2709), class= sigma)),
      cores = 2,
      chains = 4,
      iter=5000,
      sample_prior = TRUE
      #control = list(adapt_delta = 0.999, max_treedepth = 15)
      )


pp_check(m5_gaus_RT_stim, ndraws = 100)+
  ggtitle("M4 Posterior Predictive Check")
summary(m5_gaus_RT_stim)





```














```{r EX-GAUSSIAN}
################################ M4 #################################################  
  
   
get_prior(data = data_response, family = exgaussian(), RT ~ 1 + gender + (1| gender:ID))

m4_prior <-
  brm(data = data_response,
      family = exgaussian(),
      RT ~ 1 + gender + (1| gender:ID),
      prior =  c(prior(student_t(3, 5787, 2709), class = Intercept),
               prior(normal(0, 1000), class = b),
               prior(student_t(3, 0, 2709), class = sd),
               prior(student_t(3, 0, 2709), class= sigma),
               prior(gamma(1, 0.1), class = beta)), #dont know why this gives an error... It is what it suggests in get_prior...
      cores=2,
      chains=4,
      sample_prior = "only")

pp_check(m4_prior, ndraws = 100)+
  ggtitle("M4 Prior Predictive Check")

#################
#ESS is too low (even for 5000 iterations...)
m4 <-
  brm(data = data_response,
      family = exgaussian,
      RT ~ 1 + gender + (1| gender:ID),
      prior=c(prior(student_t(3, 5787, 2709), class = Intercept),
                prior(normal(0, 1000), class = b),
                prior(student_t(3, 0, 2709), class = sd),
                prior(student_t(3, 0, 2709), class= sigma),
                prior(gamma(1, 0.1), class = beta)),
      cores = 2,
      chains = 4,
      iter=2000,
      sample_prior = TRUE,
      #control = list(adapt_delta = 0.999, max_treedepth = 15) #this line doesn't work after updating Stan.... "Fejl i unserialize(socklist[[n]]) : fejl under læsning fra forbindelse" 
      )


pp_check(m4, nsamples = 100)+
  ggtitle("M4 Posterior Predictive Check")
summary(m4)

  
```

